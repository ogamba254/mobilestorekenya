<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart | MobileStore Kenya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @keyframes breathe {
            0%, 100% { box-shadow: 0 0 5px rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.8); }
        }
        .logo-box { animation: breathe 3s infinite ease-in-out; transition: transform 0.3s ease; }
        .logo-box:hover { transform: rotate(-10deg) scale(1.1); cursor: pointer; }
        .bg-mpesa { background-color: #49aa47; }
        .hover-mpesa:hover { background-color: #3d8e3b; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 md:px-10 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="window.location.href='index.html'">
                <div id="mainLogo" class="logo-box bg-red-600 text-white p-2 rounded-lg font-bold text-2xl flex items-center justify-center w-12 h-12">MS</div>
                <div class="flex flex-col leading-tight">
                    <span class="text-xl font-black text-gray-900 tracking-tighter uppercase">MobileStore</span>
                    <span class="text-sm font-bold text-red-600 tracking-widest uppercase">Kenya</span>
                </div>
            </div>
            <a href="index.html" class="text-gray-600 hover:text-red-600 font-bold text-sm">‚Üê Continue Shopping</a>
        </div>
    </nav>

    <div class="container mx-auto px-4 md:px-10 py-12">
        <h1 class="text-3xl font-black text-gray-900 mb-8">Shopping Basket <span class="text-red-600" id="itemCountDisplay">(0 Items)</span></h1>

        <div class="flex flex-col lg:flex-row gap-10">
            <div id="cartItemsList" class="w-full lg:w-2/3 space-y-4"></div>
            <div class="w-full lg:w-1/3">
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 sticky top-28">
                    <h2 class="text-xl font-black text-gray-900 mb-6">Order Summary</h2>
                    <div class="space-y-4 text-gray-600 border-b pb-6">
                        <div class="flex justify-between"><span>Subtotal</span><span class="font-bold text-gray-900" id="subtotalDisplay">KSh 0</span></div>
                        <div class="flex justify-between"><span>Delivery</span><span class="font-bold text-green-600 uppercase text-sm italic">Free</span></div>
                    </div>
                    <div class="flex justify-between items-center py-6">
                        <span class="text-lg font-bold">Total Amount</span>
                        <span class="text-2xl font-black text-red-600" id="totalDisplay">KSh 0</span>
                    </div>
                    <button onclick="showMpesa()" class="w-full bg-mpesa hover-mpesa text-white py-4 rounded-2xl font-black flex items-center justify-center space-x-3 transition-all shadow-lg">
                        <span>Checkout with M-Pesa</span>
                        <i class="fa-solid fa-mobile-screen"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="mpesaModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 text-center shadow-2xl">
            <h3 class="text-2xl font-black text-gray-900">Lipa na M-Pesa</h3>
            <p class="text-gray-500 mt-2">Enter your number for KSh <span id="modalTotal" class="text-mpesa font-bold">0</span></p>
            <div class="mt-6 text-left">
                <label class="text-xs font-bold text-gray-400 uppercase">Phone Number</label>
                <div class="flex items-center border-2 border-gray-100 rounded-xl px-4 py-3 mt-1">
                    <span class="font-bold text-gray-400 mr-2">+254</span>
                    <input type="number" id="mpesaPhoneNumber" placeholder="712345678" class="w-full focus:outline-none font-bold text-lg">
                </div>
            </div>
            <p id="stkStatus" class="mt-4 text-sm font-bold hidden"></p>
            <button id="mpesa-send" onclick="createOrderFromCart(event)" class="w-full mt-6 bg-mpesa text-white py-4 rounded-2xl font-black hover-mpesa transition-all">
                Confirm & Pay Now
            </button>
            <button onclick="closeMpesa()" class="mt-4 text-gray-400 font-bold text-sm hover:text-red-600">Cancel</button>
        </div>
    </div>

    <script>
        function renderCart() {
            const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            const container = document.getElementById('cartItemsList');
            const itemCountDisplay = document.getElementById('itemCountDisplay');
            if (cartItems.length === 0) {
                container.innerHTML = `<div class="text-center py-20 bg-white rounded-3xl border border-dashed border-gray-300">Basket Empty</div>`;
                updateTotals(0); return;
            }
            itemCountDisplay.innerText = `(${cartItems.length} Items)`;
            container.innerHTML = '';
            let total = 0;
            cartItems.forEach((item, index) => {
                const itemTotal = item.price * (item.quantity || 1);
                total += itemTotal;
                container.innerHTML += `<div class="bg-white p-6 rounded-2xl border flex items-center gap-6">
                    <img src="${item.img}" class="w-16 h-16 object-cover rounded-lg">
                    <div class="flex-1 font-bold">${item.name}</div>
                    <div class="font-black text-red-600">KSh ${itemTotal.toLocaleString()}</div>
                </div>`;
            });
            updateTotals(total);
        }

        function updateTotals(total) {
            document.getElementById('subtotalDisplay').innerText = `KSh ${total.toLocaleString()}`;
            document.getElementById('totalDisplay').innerText = `KSh ${total.toLocaleString()}`;
            document.getElementById('modalTotal').innerText = total.toLocaleString();
        }

        function showMpesa() { document.getElementById('mpesaModal').classList.remove('hidden'); }
        function closeMpesa() { document.getElementById('mpesaModal').classList.add('hidden'); }

        async function createOrderFromCart(event) {
            if (event) event.preventDefault();

            const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            const phoneInput = document.getElementById('mpesaPhoneNumber').value;
            const statusBox = document.getElementById('stkStatus');
            const payBtn = document.getElementById('mpesa-send');

            if (!phoneInput) return alert('Enter phone number');
            
            const total = cartItems.reduce((s, it) => s + (it.price * (it.quantity || 1)), 0);
            
            // Format phone to 254XXXXXXXXX
            let formattedPhone = phoneInput;
            if (formattedPhone.startsWith('0')) {
                formattedPhone = '254' + formattedPhone.substring(1);
            } else if (formattedPhone.startsWith('7') || formattedPhone.startsWith('1')) {
                formattedPhone = '254' + formattedPhone;
            }

            payBtn.disabled = true;
            statusBox.classList.remove('hidden');
            statusBox.innerText = "Requesting STK Push...";

            try {
                // CHANGED: Added /stkpush to the URL
                const response = await fetch('https://mobilestorekenya.onrender.com/stkpush', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: total, phone: formattedPhone })
                });

                // Check if response is actually JSON
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const errorText = await response.text();
                    console.error("Server Error Response:", errorText);
                    throw new Error("Server sent back HTML instead of JSON. Check backend logs.");
                }

                const data = await response.json();
                
                if (response.ok) {
                    statusBox.innerText = "Sent! Enter PIN on your phone.";

                    const orderDetails = {
                        orderId: "MSK-" + Math.floor(100000 + Math.random() * 900000),
                        date: new Date().toLocaleDateString('en-KE', { day: 'numeric', month: 'long', year: 'numeric' }),
                        items: cartItems,
                        total: total,
                        phone: formattedPhone
                    };
                    localStorage.setItem('lastOrder', JSON.stringify(orderDetails));
                    localStorage.removeItem('cart');
                    
                    setTimeout(() => window.location.href = 'receipt.html', 4000);
                } else {
                    throw new Error(data.message || 'Safaricom API Error');
                }
            } catch (err) {
                console.error("Fetch Error:", err);
                statusBox.innerText = "Error: " + err.message;
                payBtn.disabled = false;
            }
        }
        window.onload = renderCart;
    </script>
</body>
</html>