<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS Admin | MobileStore Kenya Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .sidebar-link.active { background: #dc2626; color: white; border-radius: 12px; }
        .dark { background-color: #09090b; color: #fafafa; }
        #add-product-modal {
            display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; padding: 20px;
        }
        /* Added for Image Removal Adjustment */
        .preview-slot { position: relative; }
        .remove-img { 
            position: absolute; top: -5px; right: -5px; background: #dc2626; 
            color: white; width: 18px; height: 18px; border-radius: 50%; 
           display: flex; align-items: center; justify-content: center;
            border: 2px solid white; z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-zinc-950 font-sans transition-colors duration-300">

    <div id="add-product-modal">
        <div class="bg-white dark:bg-zinc-900 w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-2xl font-black dark:text-white uppercase">Add New Item</h3>
                <button onclick="closeProductModal()" class="text-gray-400 hover:text-red-600 transition"><i class="fa-solid fa-circle-xmark text-2xl"></i></button>
            </div>

            <form id="product-form" class="space-y-4" onsubmit="handleProductSubmit(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold uppercase text-gray-400">Category</label>
                        <select id="item-category" required class="w-full bg-gray-50 dark:bg-zinc-800 border dark:border-zinc-700 p-3 rounded-xl dark:text-white">
                            <option value="Smartphone">Smartphone</option>
                            <option value="Smart TV">Smart TV</option>
                            <option value="Laptop">Laptop</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold uppercase text-gray-400">Product Name</label>
                        <input type="text" id="item-name" required class="w-full bg-gray-50 dark:bg-zinc-800 border dark:border-zinc-700 p-3 rounded-xl dark:text-white">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold uppercase text-gray-400">Current Price (KSh)</label>
                        <input type="number" id="item-price" required class="w-full bg-gray-50 dark:bg-zinc-800 border dark:border-zinc-700 p-3 rounded-xl dark:text-white">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold uppercase text-gray-400">Old Price / Discount (KSh)</label>
                        <input type="number" id="item-old-price" placeholder="Leave empty if no discount" class="w-full bg-gray-50 dark:bg-zinc-800 border dark:border-zinc-700 p-3 rounded-xl dark:text-white">
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold uppercase text-gray-400">Product Images (Up to 6)</label>
                        <button type="button" onclick="clearImages()" class="text-[10px] text-red-500 font-bold uppercase hover:underline">Clear All</button>
                    </div>
                    <input type="file" id="item-images" accept="image/*" multiple onchange="previewMultipleFiles()" class="hidden">
                    
                    <div id="image-preview-grid" class="grid grid-cols-3 md:grid-cols-6 gap-2">
                        <div onclick="triggerFileInput()" class="preview-slot cursor-pointer w-full h-16 bg-gray-100 dark:bg-zinc-800 rounded-xl flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-200 dark:border-zinc-700 hover:border-red-500 transition-all">
                            <img class="hidden w-full h-full object-cover"><i class="fa-solid fa-camera text-gray-400 text-xs"></i>
                        </div>
                        <div onclick="triggerFileInput()" class="preview-slot cursor-pointer w-full h-16 bg-gray-100 dark:bg-zinc-800 rounded-xl flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-200 dark:border-zinc-700 hover:border-red-500 transition-all">
                            <img class="hidden w-full h-full object-cover"><i class="fa-solid fa-camera text-gray-400 text-xs"></i>
                        </div>
                        <div onclick="triggerFileInput()" class="preview-slot cursor-pointer w-full h-16 bg-gray-100 dark:bg-zinc-800 rounded-xl flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-200 dark:border-zinc-700 hover:border-red-500 transition-all">
                            <img class="hidden w-full h-full object-cover"><i class="fa-solid fa-camera text-gray-400 text-xs"></i>
                        </div>
                        <div onclick="triggerFileInput()" class="preview-slot cursor-pointer w-full h-16 bg-gray-100 dark:bg-zinc-800 rounded-xl flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-200 dark:border-zinc-700 hover:border-red-500 transition-all">
                            <img class="hidden w-full h-full object-cover"><i class="fa-solid fa-camera text-gray-400 text-xs"></i>
                        </div>
                        <div onclick="triggerFileInput()" class="preview-slot cursor-pointer w-full h-16 bg-gray-100 dark:bg-zinc-800 rounded-xl flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-200 dark:border-zinc-700 hover:border-red-500 transition-all">
                            <img class="hidden w-full h-full object-cover"><i class="fa-solid fa-camera text-gray-400 text-xs"></i>
                        </div>
                        <div onclick="triggerFileInput()" class="preview-slot cursor-pointer w-full h-16 bg-gray-100 dark:bg-zinc-800 rounded-xl flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-200 dark:border-zinc-700 hover:border-red-500 transition-all">
                            <img class="hidden w-full h-full object-cover"><i class="fa-solid fa-camera text-gray-400 text-xs"></i>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold uppercase text-gray-400">Details (One per line)</label>
                    <textarea id="item-details" rows="2" class="w-full bg-gray-50 dark:bg-zinc-800 border dark:border-zinc-700 p-3 rounded-xl dark:text-white"></textarea>
                </div>

                <button type="submit" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-red-700 transition">Save & Sync to Store</button>
            </form>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-white dark:bg-zinc-900 border-r dark:border-zinc-800 flex flex-col p-6">
            <div class="flex items-center space-x-3 mb-10">
                <div class="bg-red-600 text-white p-2 rounded-lg font-bold">MS</div>
                <span class="text-xl font-black uppercase dark:text-white">Admin Hub</span>
            </div>
            <nav class="space-y-2 flex-1">
                <button onclick="showSection('dashboard')" class="sidebar-link active w-full flex items-center space-x-3 p-3 text-sm font-bold"><i class="fa-solid fa-chart-line"></i> <span>Dashboard</span></button>
                <button onclick="showSection('inventory')" class="sidebar-link w-full flex items-center space-x-3 p-3 text-sm font-bold text-gray-500"><i class="fa-solid fa-box"></i> <span>Inventory</span></button>
                <button onclick="showSection('orders')" class="sidebar-link w-full flex items-center space-x-3 p-3 text-sm font-bold text-gray-500"><i class="fa-solid fa-receipt"></i> <span>Orders</span></button>
            </nav>
            <a href="index.html" class="p-3 text-sm font-bold text-red-600 hover:underline"><i class="fa-solid fa-shop mr-2"></i> Visit Live Store</a>
        </aside>

        <main class="flex-1 overflow-y-auto p-8">
            <header class="flex justify-between items-center mb-8">
                <h2 id="section-title" class="text-3xl font-black dark:text-white uppercase">Dashboard Overview</h2>
            </header>

            <div id="dashboard-section" class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-zinc-900 p-6 rounded-3xl shadow-sm border dark:border-zinc-800">
                        <p class="text-gray-400 text-xs font-bold uppercase mb-1">Total Products</p>
                        <h3 id="stat-count" class="text-3xl font-black dark:text-white">0</h3>
                    </div>
                </div>
                <div class="bg-white dark:bg-zinc-900 p-8 rounded-[2.5rem] border dark:border-zinc-800">
                    <canvas id="salesChart" height="100"></canvas>
                </div>
            </div>

            <div id="inventory-section" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-xl dark:text-white">Product Management</h3>
                    <button onclick="openProductModal()" class="bg-red-600 text-white px-6 py-3 rounded-2xl font-bold uppercase text-xs">Add Product</button>
                </div>
                <div class="flex items-center gap-3 bg-white dark:bg-zinc-900 p-4 rounded-2xl border dark:border-zinc-800">
                    <i class="fa-solid fa-magnifying-glass text-gray-400 text-lg"></i>
                    <input type="text" id="product-search" placeholder="Search products by name or category..." oninput="handleProductSearch(this.value)" class="w-full bg-transparent outline-none dark:text-white text-sm font-medium placeholder-gray-400">
                    <span id="search-count" class="text-xs text-gray-500 font-bold"></span>
                </div>
                <div class="bg-white dark:bg-zinc-900 rounded-[2rem] border dark:border-zinc-800 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 dark:bg-zinc-800 text-gray-500 text-xs uppercase">
                            <tr><th class="p-5">Product</th><th class="p-5">Category</th><th class="p-5">Price</th><th class="p-5 text-right">Action</th></tr>
                        </thead>
                        <tbody id="inventory-table"></tbody>
                    </table>
                </div>
            </div>

            <div id="orders-section" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-xl dark:text-white">Customer Orders</h3>
                </div>
                <div class="bg-white dark:bg-zinc-900 rounded-[2rem] border dark:border-zinc-800 overflow-hidden p-4">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 dark:bg-zinc-800 text-gray-500 text-xs uppercase">
                            <tr>
                                <th class="p-3">Order</th>
                                <th class="p-3">Customer</th>
                                <th class="p-3">Items</th>
                                <th class="p-3">Total</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Date</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'https://mobilestorekenya.onrender.com/api/products';
        let inventory = [];
        let filteredInventory = [];
        let editingProductId = null;
        let searchQuery = '';
        let productImagesArray = []; 

        window.addEventListener('load', () => {
            const token = localStorage.getItem('authToken');
            const role = localStorage.getItem('userRole');
            if (!token || role !== 'admin') {
                alert('Access denied. Admin login required.');
                window.location.href = 'login.html';
                return;
            }
            loadInventoryFromAPI();
            loadAdminOrders();
        });

        async function loadInventoryFromAPI() {
            try {
                const response = await fetch(API_URL);
                const text = await response.text();
                inventory = text ? JSON.parse(text) : [];
                loadInventory();
                updateStats();
            } catch (error) {
                console.error('Error loading inventory:', error);
                inventory = [];
                loadInventory();
            }
        }

        function triggerFileInput() {
            document.getElementById('item-images').click();
        }

        function clearImages() {
            productImagesArray = [];
            updateImageGrid();
            document.getElementById('item-images').value = "";
        }

        /* Adjustment: Individual Image Removal */
        function removeImage(index, event) {
            event.stopPropagation();
            productImagesArray.splice(index, 1);
            updateImageGrid();
        }

        function previewMultipleFiles() {
            const files = document.getElementById('item-images').files;
            Array.from(files).forEach(file => {
                if (productImagesArray.length < 6) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        productImagesArray.push(e.target.result);
                        updateImageGrid();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function updateImageGrid() {
            const slots = document.querySelectorAll('.preview-slot');
            slots.forEach((slot, index) => {
                const imgTag = slot.querySelector('img');
                const iconTag = slot.querySelector('i');
                
                // Clear previous remove button
                const existingBtn = slot.querySelector('.remove-img');
                if(existingBtn) existingBtn.remove();

                if (productImagesArray[index]) {
                    imgTag.src = productImagesArray[index];
                    imgTag.classList.remove('hidden');
                    iconTag.classList.add('hidden');
                    
                    /* Adjustment: Add Removal Icon */
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'remove-img';
                    removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                    removeBtn.onclick = (e) => removeImage(index, e);
                    slot.appendChild(removeBtn);
                } else {
                    imgTag.classList.add('hidden');
                    iconTag.classList.remove('hidden');
                }
            });
        }

        async function handleProductSubmit(e) {
            e.preventDefault();
            const token = localStorage.getItem('authToken');
            
            const newItem = {
                name: document.getElementById('item-name').value,
                price: parseInt(document.getElementById('item-price').value),
                oldPrice: document.getElementById('item-old-price').value ? parseInt(document.getElementById('item-old-price').value) : null,
                category: document.getElementById('item-category').value,
                img: productImagesArray[0] || 'https://via.placeholder.com/150', 
                images: productImagesArray, 
                /* Adjustment: Changed details to specs to match shop frontend */
                specs: document.getElementById('item-details').value.split('\n').map(d => d.trim()).filter(d => d !== "")
            };

            try {
                const url = editingProductId ? `${API_URL}/${editingProductId}` : `${API_URL}/add`;
                const method = editingProductId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(newItem)
                });

                if (response.ok) {
                    alert('Success!');
                    loadInventoryFromAPI();
                    closeProductModal();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.message || 'Server error'));
                }
            } catch (error) {
                alert('Connection Error: ' + error.message);
            }
        }

        function loadInventory() {
            const table = document.getElementById('inventory-table');
            const displayItems = searchQuery ? filteredInventory : inventory;
            table.innerHTML = displayItems.map((item) => `
                <tr class="border-t dark:border-zinc-800 dark:text-white">
                    <td class="p-5 flex items-center gap-3">
                        <img src="${item.img || 'https://via.placeholder.com/150'}" class="w-10 h-10 rounded shadow object-cover">
                        <span class="font-bold uppercase text-xs">${item.name}</span>
                    </td>
                    <td class="p-5 text-sm font-bold text-gray-400">${item.category}</td>
                    <td class="p-5">
                        <span class="text-red-600 font-black">KSh ${item.price.toLocaleString()}</span>
                    </td>
                    <td class="p-5 text-right">
                        <button onclick="editItem('${item._id}')" class="text-gray-400 hover:text-blue-600 mr-3"><i class="fa-solid fa-edit"></i></button>
                        <button onclick="deleteItem('${item._id}')" class="text-gray-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function editItem(id) {
            const product = inventory.find(p => p._id === id);
            if (!product) return;

            editingProductId = id;
            document.getElementById('modal-title').innerText = 'Edit Product';
            document.getElementById('item-name').value = product.name;
            document.getElementById('item-category').value = product.category;
            document.getElementById('item-price').value = product.price;
            document.getElementById('item-old-price').value = product.oldPrice || '';
            
            /* Adjustment: Load from specs or details */
            const displaySpecs = product.specs || product.details || [];
            document.getElementById('item-details').value = displaySpecs.join('\n');
            
            productImagesArray = product.images || (product.img ? [product.img] : []);
            updateImageGrid();
            document.getElementById('add-product-modal').style.display = 'flex';
        }

        function closeProductModal() { 
            editingProductId = null;
            clearImages();
            document.getElementById('add-product-modal').style.display = 'none'; 
            document.getElementById('product-form').reset(); 
        }

        function handleProductSearch(query) {
            searchQuery = query.toLowerCase().trim();
            filteredInventory = inventory.filter(item => 
                item.name.toLowerCase().includes(searchQuery) || 
                item.category.toLowerCase().includes(searchQuery)
            );
            loadInventory();
        }

        async function deleteItem(id) {
            if(!confirm('Remove this product?')) return;
            const token = localStorage.getItem('authToken');
            try {
                await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadInventoryFromAPI();
            } catch (e) { alert('Delete failed'); }
        }

        function updateStats() { 
            const statEl = document.getElementById('stat-count');
            if (statEl) statEl.innerText = inventory.length; 
        }

        /* Adjustment: Fix ghost images on open */
        function openProductModal() { 
            editingProductId = null;
            document.getElementById('modal-title').innerText = 'Add New Item';
            clearImages();
            document.getElementById('product-form').reset(); 
            document.getElementById('add-product-modal').style.display = 'flex'; 
        }

        function showSection(section) {
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('inventory-section').classList.add('hidden');
            document.getElementById('orders-section').classList.add('hidden');
            document.getElementById(section + '-section').classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-link').forEach(btn => btn.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.sidebar-link')).find(btn => btn.innerText.toLowerCase().includes(section));
            if (activeBtn) activeBtn.classList.add('active');
            
            document.getElementById('section-title').innerText = section.toUpperCase() + ' Overview';
        }

        const salesCtx = document.getElementById('salesChart').getContext('2d');
        new Chart(salesCtx, { type: 'line', data: { labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], datasets: [{ label: 'Sales', data: [5,12,8,15,10,20,18], borderColor: '#dc2626', tension: 0.4 }] } });

        async function loadAdminOrders() {
            const token = localStorage.getItem('authToken');
            if (!token) return;
            try {
                const resp = await fetch('https://mobilestorekenya.onrender.com/api/orders/all', { headers: { 'Authorization': 'Bearer ' + token } });
                const orders = await resp.json();
                renderOrdersTable(orders);
            } catch (e) { console.error(e); }
        }

        function renderOrdersTable(orders) {
            const tbody = document.getElementById('orders-table');
            if (!tbody) return;
            tbody.innerHTML = orders.map(o => `
                <tr class="border-t dark:border-zinc-800 dark:text-white align-top">
                    <td class="p-3"><div class="font-bold text-xs">${o._id.slice(-5)}</div></td>
                    <td class="p-3">${o.user ? o.user.username : 'Guest'}</td>
                    <td class="p-3">${(o.items || []).length} items</td>
                    <td class="p-3 font-black text-red-600 text-sm">KSh ${(o.totalAmount || 0).toLocaleString()}</td>
                    <td class="p-3"><span class="bg-gray-100 dark:bg-zinc-800 px-2 py-1 rounded text-[10px] uppercase font-bold">${o.status}</span></td>
                    <td class="p-3 text-xs">${new Date(o.orderDate).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>